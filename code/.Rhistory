library(dplyr)
library(haven)
library(survey)
library(lme4)
library(sf)
library(questionr)
library(splines)
library(car)
### DHS data
# individual recode
saf<-read_dta("C:/Users/ozd504/OneDrive - University of Texas at San Antonio/projects/AFRICA_ph//data/ZA_2016_DHS_02252021_1635_24890/ZAIR71DT/ZAIR71FL.DTA")
saf<-zap_labels(saf)
# mens recode
sam<-read_dta("C:/Users/ozd504/OneDrive - University of Texas at San Antonio/projects/AFRICA_ph//data/ZA_2016_DHS_02252021_1635_24890/ZAMR71DT/ZAMR71FL.DTA")
sam<-zap_labels(sam)
#women's health survey
saf_wh<-read_dta("C:/Users/ozd504/OneDrive - University of Texas at San Antonio/projects/AFRICA_ph//data/ZA_2016_DHS_02252021_1635_24890/ZAAH71DT/ZAAHW71FL.DTA")
saf_wh<-zap_labels(saf_wh)
# Men's health survey
saf_mh<-read_dta("C:/Users/ozd504/OneDrive - University of Texas at San Antonio/projects/AFRICA_ph//data/ZA_2016_DHS_02252021_1635_24890/ZAAH71DT/ZAAHM71FL.DTA")
saf_mh<-zap_labels(saf_mh)
##HIV data
safhiv<-read_dta("C:/Users/ozd504/OneDrive - University of Texas at San Antonio/projects/AFRICA_ph//data/ZA_2016_DHS_03182021_1437_24890/ZAAR71DT/ZAAR71FL.DTA")
safhiv<-zap_labels(safhiv)
## Merging data
#womens recode to health survey
saf2<-merge(saf, saf_wh, by=c("v001", "v002", "v003"), all.x = T)
#womens merge to hiv
saf2<-merge(saf2, safhiv, by.x=c("v001", "v002", "v003"), by.y = c("hivclust", "hivnumb" , "hivline"), all.x = T)
#mens recode to health survey
sam2<-merge(sam, saf_mh, by=c("mv001", "mv002", "mv003"), all.x = T)
#mens merge to hiv
sam2<-merge(sam2, safhiv, by.x=c("mv001", "mv002", "mv003"), by.y = c("hivclust", "hivnumb" , "hivline"), all.x = T)
### DHS Spatial data
#polygons
saf2_adm2<- st_read("C:/Users/ozd504/OneDrive - University of Texas at San Antonio/projects/AFRICA_ph/data/ZAF_adm/ZAF_adm2.shp")
saf2_adm2<- st_transform(saf2_adm2, crs = 32734 )
saf2_adm1<- st_read("C:/Users/ozd504/OneDrive - University of Texas at San Antonio/projects/AFRICA_ph//data/ZAF_adm/ZAF_adm1.shp")
saf2_adm1<- st_transform(saf2_adm1, crs = 32734 )
saf2_adm0<- st_read("C:/Users/ozd504/OneDrive - University of Texas at San Antonio/projects/AFRICA_ph//data/ZAF_adm/ZAF_adm0.shp")
saf2_adm0<- st_transform(saf2_adm0, crs = 32734 )
#psu locations
saf2_dhs_psu<- st_read("C:/Users/ozd504/OneDrive - University of Texas at San Antonio/projects/AFRICA_ph//data/ZA_2016_DHS_02262021_2058_24890/ZAGE71FL/ZAGE71FL.shp")
saf2_dhs_psu<- st_transform(saf2_dhs_psu, crs =32734 )
saf_regions<- st_read("C:/Users/ozd504/OneDrive - University of Texas at San Antonio/projects/AFRICA_ph//data/ZAF_adm/ZAF_adm1.shp")
saf_regions <- saf_regions%>%
filter(NAME_1!= "Western Cape (isolated islands)")
saf_regions$dhs_reg <- car::Recode(saf_regions$ID_1, recodes = "1 = 2; 2 = 4; 3= 7; 4=5; 5=9; 6=8; 7=6;8=3; 10= 1")
## merge psu and adm2
saf2_sp_join <- st_intersection(saf2_adm2, saf2_dhs_psu)
## make figure 1
library(tmap); library(tmaptools)
# figure 3
library(tmap); library(tmaptools)
pstrat<- st_read("C:/Users/ozd504/OneDrive - University of Texas at San Antonio/projects/AFRICA_ph//data/poststrat_cl_noisl.dbf.gpkg")
# pstrat<-pstrat%>%
#    filter(MUNI2016!="1991011")
pstrat <- pstrat%>%
filter(NAME_1 != "Western Cape (isolated islands)")
ps1<-pstrat
st_geometry(ps1)<-NULL
library(spdep)
nbs <- poly2nb(pstrat, queen = T)
#nbs<-knn2nb(nbs)
wts<-nb2listw(nbs, style="B")
pstrat$hivg <- localG(pstrat$ratehiv, listw=wts)
pstrat$drinkg <- localG(pstrat$ratecage, listw=wts)
pstrat$ipvg <- localG(pstrat$rateipv, listw=wts)
pstrat$condg <- localG(pstrat$ratecond, listw=wts)
table(pstrat$hivg>3, pstrat$NAME_1)
table(pstrat$drinkg>3, pstrat$NAME_1)
table(pstrat$ipvg>3, pstrat$NAME_1)
table(pstrat$condg>3, pstrat$NAME_1)
table(pstrat$hivg< -3, pstrat$NAME_1)
table(pstrat$drinkg< -3, pstrat$NAME_1)
table(pstrat$ipvg< -3, pstrat$NAME_1)
table(pstrat$condg< -3, pstrat$NAME_1)
hivcl <- localmoran(pstrat$ratehiv, listw=wts)
hivcl_l <- as.character(attr(hivcl, "quadr")$mean)
pstrat$hivcl <- ifelse(hivcl[, 5]<.05,hivcl_l, NA)
levels(pstrat$hivcl) <- levels(attr(hivcl, "quadr")$mean)
drinkcl <- localmoran(pstrat$ratecage, listw=wts)
drinkccl_l <- as.character(attr(drinkcl, "quadr")$mean)
pstrat$drinkccl <- ifelse(drinkcl[, 5]<.05,drinkccl_l, NA)
levels(pstrat$drinkccl) <- levels(attr(hivcl, "quadr")$mean)
ipvcl <- localmoran(pstrat$rateipv, listw=wts)
ipvcl_l <- as.character(attr(ipvcl, "quadr")$mean)
pstrat$ipvcl <- ifelse(ipvcl[, 5]<.05,ipvcl_l, NA)
levels(pstrat$ipvcl) <- levels(attr(hivcl, "quadr")$mean)
condcl <- localmoran(pstrat$ratecond, listw=wts)
condcl_l <- as.character(attr(condcl, "quadr")$mean)
pstrat$condcl <- ifelse(condcl[, 5]<.05,condcl_l, NA)
levels(pstrat$condcl) <- levels(attr(hivcl, "quadr")$mean)
# pstrat$drinkcl <-  attr(localmoran(pstrat$ratecage, listw=wts), "quadr")$mean
# pstrat$ipvcl <-  attr(localmoran(pstrat$rateipv, listw=wts), "quadr")$mean
# pstrat$condcl <-  attr(localmoran(pstrat$ratecond, listw=wts), "quadr")$mean
#
MyPalette1 <- c("#CA0020", "#F4A582",  "#0571B0")
MyPalette2 <-c("#CA0020", "#F4A582", "#92C5DE", "#0571B0")
tmap_mode("plot")
f1<-tm_basemap("Esri.WorldGrayCanvas")+
tm_shape(pstrat, is.master = T)+
#tm_borders(col = "grey20", alpha = .4, lty = 3 )+
tm_polygons("hivg", title="HIV Local Cluster")+
# tm_shape(saf2_dhs_psu)+
# tm_dots(size =.05)+
tm_format(format = "World", legend.outside=T)+
tm_shape(saf2_adm1)+
tm_borders(col ="black",lwd=2, lty=1)
f1
# tm_text("NAME_1", bg.color="grey20", bg.alpha = .25,  auto.placement = 1,scale=1, root=4)+
#  tm_legend(legend.show=T)+
# tm_scale_bar(position=c("left", "top"))+
# tm_compass(position =c("left", "top"))
f2<-tm_basemap("Esri.WorldGrayCanvas")+
tm_shape(pstrat, is.master = T)+
#tm_borders(col = "grey20", alpha = .4, lty = 3 )+
tm_polygons("ipvg", title="Local IPV Cluster" )+
# tm_shape(saf2_dhs_psu)+
# tm_dots(size =.05)+
tm_format(format = "World", legend.outside=T)+
tm_shape(saf2_adm1)+
tm_borders(col ="black",lwd=2, lty=1)
# tm_text("NAME_1", bg.color="grey20", bg.alpha = .25,  auto.placement = 1,scale=1, root=4)+
#  tm_legend(legend.show=T)+
#tm_scale_bar(position=c("left", "top"))+
#tm_compass(position =c("left", "top"))
f3<-tm_basemap("Esri.WorldGrayCanvas")+
tm_shape(pstrat, is.master = T)+
#tm_borders(col = "grey20", alpha = .4, lty = 3 )+
tm_polygons("drinkg", title="Local Alcohol\nUse Cluster")+
# tm_shape(saf2_dhs_psu)+
# tm_dots(size =.05)+
tm_format(format = "World", legend.outside=T)+
tm_shape(saf2_adm1)+
tm_borders(col ="black",lwd=2, lty=1)
# tm_text("NAME_1", bg.color="grey20", bg.alpha = .25,  auto.placement = 1,scale=1, root=4)+
#  tm_legend(legend.show=T)+
#  tm_scale_bar(position=c("left", "top"))+
# tm_compass(position =c("left", "top"))
f4<-tm_basemap("Esri.WorldGrayCanvas")+
tm_shape(pstrat, is.master = T)+
#tm_borders(col = "grey20", alpha = .4, lty = 3 )+
tm_polygons("condg", title="Local Risky Sex\n Cluster")+
# tm_shape(saf2_dhs_psu)+
# tm_dots(size =.05)+
tm_format(format = "World", legend.outside=T)+
tm_shape(saf2_adm1)+
tm_borders(col ="black",lwd=2, lty=1)+
# tm_text("NAME_1", bg.color="grey20", bg.alpha = .25,  auto.placement = 1,scale=1, root=4)+
#  tm_legend(legend.show=T)+
tm_scale_bar(position=c("left", "top"))+
tm_compass(position =c("left", "top"))
f2_all<-tmap_arrange(f1, f2, f3, f4, ncol =2)
tmap_save(f2_all, filename = "../images/figure3.png" )
